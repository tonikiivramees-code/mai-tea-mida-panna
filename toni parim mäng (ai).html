<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Põgenemine Koletise Eest</title>
    <style>
        html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#0b1020;color:#fff}
        .center{display:flex;align-items:center;justify-content:center;height:100%}
        canvas{background:linear-gradient(#071029,#0f1b2b);border-radius:8px;display:block}
        .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
        .menu{background:linear-gradient(135deg,rgba(30,20,40,0.9) 0%,rgba(0,0,0,0.8) 100%);padding:24px;border-radius:10px;text-align:center;min-width:320px;border:2px solid rgba(100,80,200,0.3)}
        button{margin:8px;padding:10px 16px;border-radius:8px;border:none;background:#2ecc71;color:#062018;font-weight:700;cursor:pointer;transition:all 0.2s}
        button:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(46,204,113,0.5)}
        .danger{background:#e74c3c;color:#fff}
        .danger:hover{box-shadow:0 0 15px rgba(231,76,60,0.5)}
        .hud{position:fixed;left:16px;top:16px;background:linear-gradient(180deg,rgba(0,0,0,0.45),rgba(0,0,0,0.25));padding:8px 12px;border-radius:8px;font-weight:700;border:1px solid rgba(255,255,255,0.04)}
        .hud.right{position:fixed;right:16px;top:16px;background:linear-gradient(180deg,rgba(0,0,0,0.45),rgba(0,0,0,0.25));padding:8px 12px;border-radius:8px}
        #coinHud{left:160px;top:16px;background:linear-gradient(90deg,rgba(255,215,100,0.08),rgba(0,0,0,0.16));border:1px solid rgba(255,215,100,0.06);color:#ffd36a}
        #pauseHint{background:linear-gradient(90deg,rgba(52,152,219,0.06),rgba(0,0,0,0.16));border:1px solid rgba(52,152,219,0.06);color:#9bd0ff}
        .level-btn{margin:6px;padding:8px 12px;border-radius:8px;border:none;color:#fff;font-weight:800;min-width:140px;cursor:pointer;transition:all 0.14s}
        .level-btn:hover{transform:translateY(-3px);box-shadow:0 6px 18px rgba(0,0,0,0.45)}
    </style>
</head>
<body>
    <div id="startOverlay" class="overlay">
        <div id="startMenu" class="menu">
            <h1>Põgenemine Koletise Eest</h1>
            <p>Sa oled väike roheline. Koletis on suur ja punane. Juhi WASD-ga, väldi kokkupuudet.</p>
            <div style="margin-top:12px">
                <button id="startBtn">Alusta mängu</button>
                <button id="levelsBtn" style="background:#3498db;color:#fff">Vali tase</button>
            </div>
        </div>
    </div>

    <div id="levelSelect" class="overlay" style="display:none">
        <div class="menu">
            <h2>Vali tase</h2>
            <div id="levelButtons"></div>
            <div style="margin-top:12px">
                <button id="closeLevelSelect">Tagasi</button>
            </div>
        </div>
    </div>

    <div id="gameOverMenu" class="overlay" style="display:none">
        <div class="menu">
            <h2>Mäng läbi</h2>
            <p id="gameOverText">Sind tabas koletis.</p>
            <div style="margin-top:12px">
                <button id="retryBtn">Proovi uuesti</button>
                <button id="toMenuBtn" class="danger">Peamenüü</button>
            </div>
        </div>
    </div>

    <div id="levelCompleteMenu" class="overlay" style="display:none">
        <div class="menu">
            <h2>Tase lõpetatud!</h2>
            <p id="levelCompleteText"></p>
            <div style="margin-top:12px">
                <button id="nextLevelBtn">Järgmine tase</button>
                <button id="levelSelectBtn">Tasemete menüü</button>
            </div>
        </div>
    </div>

    <div id="winMenu" class="overlay" style="display:none">
        <div class="menu">
            <h2>Võitsid! Kõik tasemed läbitud!</h2>
            <div style="margin-top:12px">
                <button id="winToMenu">Peamenüü</button>
            </div>
        </div>
    </div>

    <div id="pauseMenu" class="overlay" style="display:none">
        <div class="menu">
            <h2>Paus</h2>
            <div style="margin-top:12px">
                <button id="resumeBtn" style="background:#2ecc71;color:#062018">Jätka mängu</button>
                <button id="pauseLevelSelectBtn" style="background:#3498db;color:#fff">Vali tase</button>
                <button id="pauseToMenuBtn" class="danger">Peamenüü</button>
            </div>
        </div>
    </div>

    <div class="hud" id="hud">Tase: 1</div>
    <div class="hud right" id="timerHud" style="right:16px;left:auto">Aeg: 01:00</div>
    <div class="hud" id="coinHud" style="left:160px;top:16px;background:rgba(0,0,0,0.25)">Münte: 0</div>
    <div class="hud" id="shopHint" style="left:16px;top:60px;background:rgba(0,0,0,0.25);font-size:12px;padding:4px 8px">Pood: <span style="color:#2ecc71;font-weight:bold">B</span></div>
    <div class="hud" id="pauseHint" style="left:16px;top:100px;background:rgba(0,0,0,0.25);font-size:12px;padding:4px 8px">Paus: <span style="color:#3498db;font-weight:bold">ESC</span></div>

    <!-- Shop Overlay -->
    <div id="shopOverlay" class="overlay" style="display:none">
        <div class="menu">
            <h2>Pood</h2>
            <p>Mündid: <span id="shopCoins">0</span></p>
            <div style="display:flex;gap:10px;margin:12px 0;justify-content:center">
                <button id="shopTabBoosts" style="background:#3498db;color:#fff;padding:8px 16px">Boostid</button>
                <button id="shopTabCosm" style="background:#9b59b6;color:#fff;padding:8px 16px">Kaunistused</button>
            </div>
            <div id="boostSection" style="display:flex;flex-direction:column;gap:8px;align-items:center">
                <button id="buyBoost">Kiiruse boost (10 münti) — 6s</button>
                <button id="buyCoinBoost">Mündi boost x2 (12 münti) — 20s</button>
                <button id="buyPermanent">Püsikiirus + (25 münti)</button>
                <button id="buySafetyBoost">Ohutusboosx (100 münti) — koletis aeglane 45s</button>
            </div>
            <div id="cosmSection" style="display:none;flex-direction:column;gap:8px;align-items:center">
                <button id="buyHat" style="display:flex;align-items:center;gap:10px;min-width:280px">
                    <span style="display:inline-block;width:20px;height:20px;background:#ff6b35;border-radius:50%;border:2px solid #fff"></span>
                    Müts (15 münti)
                </button>
                <button id="buyRedSkin" style="display:flex;align-items:center;gap:10px;min-width:280px">
                    <span style="display:inline-block;width:20px;height:20px;background:#e03434;border-radius:50%;border:2px solid #fff"></span>
                    Punane nahk (20 münti)
                </button>
                <button id="buyBlueSkin" style="display:flex;align-items:center;gap:10px;min-width:280px">
                    <span style="display:inline-block;width:20px;height:20px;background:#3498db;border-radius:50%;border:2px solid #fff"></span>
                    Sinine nahk (20 münti)
                </button>
                <button id="buyGoldSkin" style="display:flex;align-items:center;gap:10px;min-width:280px">
                    <span style="display:inline-block;width:20px;height:20px;background:#f39c12;border-radius:50%;border:2px solid #fff"></span>
                    Kuldne nahk (50 münti)
                </button>
            </div>
            <div style="margin-top:12px">
                <button id="closeShop" class="danger">Sulge</button>
            </div>
        </div>
    </div>

    <div class="center">
        <canvas id="c" width="900" height="600"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('2d');

        function resize(){
            const maxH = window.innerHeight - 120;
            const w = Math.min(1100, window.innerWidth - 40);
            canvas.width = Math.max(640, w);
            canvas.height = Math.max(480, maxH);
        }
        window.addEventListener('resize', resize);
        resize();

        // Game state
        const GAME = {
            levels:5,
            currentLevel:0,
            levelDuration:60000, // 1 minute
            running:false,
            coins: 0,
            levelColor: null
        };

        // Player (slightly faster base speed to make game easier)
        const player = { x:120,y:120, r:16, speedBase:220, speed:220, speedBoostUntil:0, coinMultiplier:1, coinBoostUntil:0, safetyBoostUntil:0, color:'#ffffff', hasHat:false, skinColor:'#ffffff' };
        // Monster (rebalanced: still scary but a bit slower)
        const monster = { x:600,y:300, r:46, baseSpeed:50, color:'#e03434', eyeGlow:true };

        // Background clouds (for parallax)
        const clouds = [];
        for(let i=0;i<6;i++){
            clouds.push({ x: Math.random()*canvas.width*1.5, y: 40 + Math.random()*140, w: 120+Math.random()*180, h:40+Math.random()*40, speed: 8 + Math.random()*20, alpha: 0.08 + Math.random()*0.12 });
        }

        let keys = {};
        document.addEventListener('keydown', e=>keys[e.key.toLowerCase()]=true);
        document.addEventListener('keyup', e=>keys[e.key.toLowerCase()]=false);

        let levelStartTime = 0;
        let lastTime = 0;
        let coins = [];
        let shopPauseTime = 0;

        function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

        function startLevel(level){
            GAME.currentLevel = level;
            // Reset positions
            player.x = 120; player.y = canvas.height/2;
            monster.x = canvas.width - 140; monster.y = canvas.height/2;
            // reset player speed modifier
            player.speed = player.speedBase;
            player.speedBoostUntil = 0;
            // spawn coins for this level (more coins on harder levels)
            coins = [];
            const coinCount = 12 + level * 10 + (level >= GAME.levels - 2 ? 6 : 0);
            for(let i=0;i<coinCount;i++){
                const cx = 100 + Math.random()*(canvas.width-220);
                const cy = 80 + Math.random()*(canvas.height-180);
                coins.push({x:cx,y:cy,r:10, collected:false});
            }
            levelStartTime = performance.now();
            lastTime = performance.now();
            GAME.running = true;
            document.getElementById('hud').textContent = 'Tase: ' + (level+1);
            // Update level-specific colors
            updateLevelDesign(level);
            hideAllMenus();
        }

        function updateLevelDesign(level){
            // Tase 1: roheline (safe start)
            // Tase 2: kollane-oranž (warming up)
            // Tase 3: oranž-punane (getting hot)
            // Tase 4: punane (danger)
            // Tase 5: tumepunane (extreme danger)
            const colors = [
                {monster:'#2ecc71', spike:'#1e9a4d', eye:'#90ee90'},  // Green
                {monster:'#f39c12', spike:'#d68910', eye:'#ffa500'},  // Orange-yellow
                {monster:'#e67e22', spike:'#c0392b', eye:'#ff6347'},  // Orange-red
                {monster:'#e74c3c', spike:'#a93226', eye:'#ff4500'},  // Red
                {monster:'#8b0000', spike:'#4d0000', eye:'#ff0000'}   // Dark red
            ];
            GAME.levelColor = colors[Math.min(level, 4)];
        }

        function endLevelWon(){
            GAME.running = false;
            if(GAME.currentLevel < GAME.levels -1){
                document.getElementById('levelCompleteText').textContent = 'Tase ' + (GAME.currentLevel+1) + ' läbitud!';
                document.getElementById('levelCompleteMenu').style.display='flex';
            } else {
                document.getElementById('winMenu').style.display='flex';
            }
        }

        function endGameOver(){
            GAME.running = false;
            document.getElementById('gameOverText').textContent = 'Sind tabas koletis tasemel ' + (GAME.currentLevel+1) + '.';
            document.getElementById('gameOverMenu').style.display='flex';
        }

        function hideAllMenus(){
            document.querySelectorAll('.overlay').forEach(el=>el.style.display='none');
        }

        function drawLevelBackground(level){
            // Level-specific background designs
            const now = performance.now();
            if(level === 0){
                // Tase 1: Roheline mets - peaceful
                ctx.fillStyle = 'linear-gradient(to bottom, #1a3a52 0%, #0f1b2b 100%)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Green trees
                ctx.fillStyle = '#0d5f2f';
                for(let i=0;i<8;i++){
                    ctx.fillRect(i*110+20, 50+Math.sin(now/3000+i)*10, 60, 200);
                }
            } else if(level === 1){
                // Tase 2: Geel-oranž pilved
                ctx.fillStyle = 'linear-gradient(to bottom, #5a3a20 0%, #2a1a0a 50%, #0f1b2b 100%)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Yellow-orange clouds
                ctx.fillStyle = 'rgba(255,200,0,0.15)';
                for(let i=0;i<5;i++){
                    ctx.ellipse(canvas.width/5*(i+1), 80+Math.sin(now/2000+i)*20, 120, 40, 0, 0, Math.PI*2);
                    ctx.fill();
                }
            } else if(level === 2){
                // Tase 3: Oranž tuli taustapilt
                ctx.fillStyle = 'linear-gradient(to bottom, #8b4513 0%, #4a2511 50%, #1a0f05 100%)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Orange fire effect
                ctx.fillStyle = 'rgba(255,165,0,0.2)';
                for(let i=0;i<6;i++){
                    ctx.beginPath();
                    ctx.arc(canvas.width/7*(i+1), canvas.height-100+Math.sin(now/1500+i)*30, 60+Math.cos(now/1200+i)*20, 0, Math.PI*2);
                    ctx.fill();
                }
            } else if(level === 3){
                // Tase 4: Punane inferno
                ctx.fillStyle = 'linear-gradient(to bottom, #7a0000 0%, #3d0000 50%, #0a0000 100%)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Red pulsating effect
                ctx.fillStyle = 'rgba(255,0,0,0.15)';
                const pulse = Math.sin(now/800)*30;
                for(let i=0;i<4;i++){
                    ctx.beginPath();
                    ctx.arc(canvas.width/5*(i+1.5), canvas.height/2, 100+pulse, 0, Math.PI*2);
                    ctx.fill();
                }
            } else if(level === 4){
                // Tase 5: Tumepunane chaos
                ctx.fillStyle = 'linear-gradient(to bottom, #4d0000 0%, #2d0000 50%, #0a0000 100%)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Pulsating intense red
                ctx.fillStyle = 'rgba(255,0,0,0.2)';
                const intensity = Math.abs(Math.sin(now/600))*50;
                ctx.fillRect(0, 0, canvas.width, canvas.height/2 + intensity);
                // Red veins effect
                ctx.strokeStyle = 'rgba(255,50,50,0.3)';
                ctx.lineWidth = 2;
                for(let i=0;i<5;i++){
                    ctx.beginPath();
                    ctx.moveTo(Math.random()*canvas.width, 0);
                    ctx.lineTo(Math.random()*canvas.width, canvas.height);
                    ctx.stroke();
                }
            }
        }

        function update(dt){
            // player movement WASD
            const move = {x:0,y:0};
            if(keys['w']||keys['arrowup']) move.y -=1;
            if(keys['s']||keys['arrowdown']) move.y +=1;
            if(keys['a']||keys['arrowleft']) move.x -=1;
            if(keys['d']||keys['arrowright']) move.x +=1;
            const len = Math.hypot(move.x, move.y) || 1;
            player.x += (move.x/len) * player.speed * dt;
            player.y += (move.y/len) * player.speed * dt;
            // clamp to canvas
            player.x = clamp(player.x, player.r, canvas.width - player.r);
            player.y = clamp(player.y, player.r, canvas.height - player.r);

            // monster AI: pursue player — rebalanced to be less punishing
            const level = GAME.currentLevel;
            // Make levels 4 and 5 a bit easier: lower per-level increase and slightly slower monster
            const levelFactor = (level >= GAME.levels - 2) ? 18 : 30;
            const base = monster.baseSpeed + level * levelFactor + (level >= GAME.levels - 2 ? -6 : 0); // milder per-level increase for last two levels
            const dx = player.x - monster.x;
            const dy = player.y - monster.y;
            const d = Math.hypot(dx,dy) || 1;
            // If close, monster dashes a bit faster but less aggressively
            let speedMultiplier = 1;
            if(d < 160) speedMultiplier = 1.4 + (160 - d)/160 * 0.7;
            // Check if safety boost is active (slows monster)
            let monsterSpeed = base * speedMultiplier;
            if(player.safetyBoostUntil && performance.now() < player.safetyBoostUntil){
                monsterSpeed *= 0.3; // koletis on 70% aeglasem
            }
            // reduced jitter so movement is more predictable
            const timeNow = performance.now();
            monster.x += (dx/d) * monsterSpeed * dt + Math.sin(timeNow/220 + monster.x) * 4 * dt;
            monster.y += (dy/d) * monsterSpeed * dt + Math.cos(timeNow/260 + monster.y) * 3 * dt;

            // update clouds
            for(const cl of clouds){ cl.x -= cl.speed * dt; if(cl.x + cl.w < -100) cl.x = canvas.width + 200; }

            // collision with monster
            if(Math.hypot(player.x - monster.x, player.y - monster.y) < player.r + monster.r - 6){
                endGameOver();
            }

            // coin pickups
            for(const c of coins){
                if(!c.collected){
                    const d = Math.hypot(player.x - c.x, player.y - c.y);
                    if(d < player.r + c.r - 2){
                        c.collected = true;
                        const gain = Math.round(1 * (player.coinMultiplier || 1));
                        GAME.coins += gain;
                        document.getElementById('coinHud').textContent = 'Münte: ' + GAME.coins;
                        document.getElementById('shopCoins').textContent = GAME.coins;
                    }
                }
            }

            // speed boost expiration
            if(player.speedBoostUntil && performance.now() > player.speedBoostUntil){
                player.speed = player.speedBase;
                player.speedBoostUntil = 0;
            }
            // coin boost expiration
            if(player.coinBoostUntil && performance.now() > player.coinBoostUntil){
                player.coinMultiplier = 1;
                player.coinBoostUntil = 0;
            }
            // safety boost expiration
            if(player.safetyBoostUntil && performance.now() > player.safetyBoostUntil){
                player.safetyBoostUntil = 0;
            }

            // timer
            const elapsed = performance.now() - levelStartTime;
            const remaining = Math.max(0, GAME.levelDuration - elapsed);
            const sec = Math.floor(remaining/1000);
            const mm = String(Math.floor(sec/60)).padStart(2,'0');
            const ss = String(sec%60).padStart(2,'0');
            document.getElementById('timerHud').textContent = 'Aeg: ' + mm + ':' + ss;

            if(remaining <= 0){
                // level won
                endLevelWon();
            }
        }

        function draw(){
            // background
            ctx.clearRect(0,0,canvas.width,canvas.height);
            drawLevelBackground(GAME.currentLevel);
            
            // faint stars
            for(let i=0;i<80;i++){
                ctx.fillStyle = 'rgba(255,255,255,0.02)';
                ctx.fillRect((i*47)%canvas.width,(i*31)%canvas.height,2,2);
            }

            // draw background: stars, moon, clouds, silhouettes
            // deep night gradient already applied via CSS background, add moon glow
            // moon
            const moonX = canvas.width - 140;
            const moonY = 110;
            const moonR = 48;
            const g = ctx.createRadialGradient(moonX, moonY, 10, moonX, moonY, moonR*3);
            g.addColorStop(0, 'rgba(255,250,220,0.9)');
            g.addColorStop(0.4, 'rgba(255,250,220,0.28)');
            g.addColorStop(1, 'rgba(10,12,20,0)');
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(moonX, moonY, moonR*2.2, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,210,0.95)'; ctx.beginPath(); ctx.arc(moonX, moonY, moonR, 0, Math.PI*2); ctx.fill();

            // clouds
            for(const cl of clouds){
                ctx.fillStyle = 'rgba(18,24,36,'+cl.alpha+')';
                ctx.beginPath();
                ctx.ellipse(cl.x, cl.y, cl.w, cl.h, 0, 0, Math.PI*2);
                ctx.fill();
            }

            // silhouettes (trees/houses along bottom)
            ctx.fillStyle = '#071219';
            ctx.beginPath();
            ctx.moveTo(0, canvas.height);
            for(let i=0;i<canvas.width;i+=80){
                const h = 30 + (i%160===0?80:30 + (i%240===0?50:0));
                ctx.lineTo(i + 40, canvas.height - h);
                ctx.lineTo(i+80, canvas.height);
            }
            ctx.lineTo(canvas.width, canvas.height);
            ctx.fill();

            // mild fog overlay
            ctx.fillStyle = 'rgba(8,12,20,0.12)'; ctx.fillRect(0, canvas.height-140, canvas.width, 140);

            // draw coins
            for(const c of coins){
                if(c.collected) continue;
                // coin glow
                const cg = ctx.createRadialGradient(c.x, c.y, 2, c.x, c.y, 22);
                cg.addColorStop(0, 'rgba(255,240,130,0.95)');
                cg.addColorStop(0.6, 'rgba(255,200,80,0.45)');
                cg.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = cg; ctx.beginPath(); ctx.arc(c.x,c.y,14,0,Math.PI*2); ctx.fill();
                ctx.fillStyle = '#ffd34d'; ctx.beginPath(); ctx.arc(c.x,c.y,8,0,Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff7d6'; ctx.beginPath(); ctx.arc(c.x-3,c.y-3,2.2,0,Math.PI*2); ctx.fill();
            }

            // draw player (decorated)
            // body gradient with subtle glow based on skin
            const pg = ctx.createLinearGradient(player.x-12, player.y-12, player.x+12, player.y+12);
            pg.addColorStop(0, player.skinColor); 
            pg.addColorStop(1, player.skinColor);
            // subtle glow
            ctx.save();
            ctx.shadowBlur = 18;
            ctx.shadowColor = player.skinColor;
            ctx.beginPath(); ctx.fillStyle = pg; ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fill();
            ctx.restore();
            // outline
            ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(0,0,0,0.35)'; ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.stroke();
            // leaf hat or cosmetic hat
            if(player.hasHat){
                ctx.fillStyle = '#ff6b35'; ctx.beginPath(); ctx.ellipse(player.x, player.y - player.r + 2, 12, 8, -0.4, 0, Math.PI*2); ctx.fill();
            } else {
                ctx.fillStyle = '#1b7a3a'; ctx.beginPath(); ctx.ellipse(player.x, player.y - player.r + 4, 10, 5, -0.5, 0, Math.PI*2); ctx.fill();
            }
            ctx.fillStyle='#083'; ctx.beginPath(); ctx.arc(player.x-4,player.y-3,2,0,Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(player.x+4,player.y-3,2,0,Math.PI*2); ctx.fill();

            // draw monster (scarier): pulsating body, glowing eyes, teeth, spikes
            const now = performance.now();
            const pulse = 1 + Math.sin(now/140) * 0.06;
            const mr = monster.r * pulse;
            const monsterColor = GAME.levelColor ? GAME.levelColor.monster : monster.color;
            const spikeColor = GAME.levelColor ? GAME.levelColor.spike : '#7a0000';
            const eyeColor = GAME.levelColor ? GAME.levelColor.eye : '#ff5050';
            // shadow
            ctx.beginPath(); ctx.fillStyle = 'rgba(0,0,0,0.25)'; ctx.ellipse(monster.x+6, monster.y+12, mr*1.15, mr*0.5, 0, 0, Math.PI*2); ctx.fill();
            // body
            ctx.beginPath(); ctx.fillStyle = monsterColor; ctx.arc(monster.x,monster.y,mr,0,Math.PI*2); ctx.fill();
            // spikes around head
            ctx.fillStyle = spikeColor;
            for(let a=0;a<Math.PI*2;a+=Math.PI/7){
                const sx = monster.x + Math.cos(a) * (mr + 6);
                const sy = monster.y + Math.sin(a) * (mr + 6);
                ctx.beginPath(); ctx.moveTo(sx,sy);
                ctx.lineTo(sx + Math.cos(a+0.3)*18, sy + Math.sin(a+0.3)*18);
                ctx.lineTo(sx + Math.cos(a-0.3)*18, sy + Math.sin(a-0.3)*18);
                ctx.fill();
            }
            // glowing eyes
            const eyeOffsetX = Math.min(12, mr*0.35);
            const eyeY = monster.y - mr*0.25;
            let eyeR = 255, eyeG = 80, eyeB = 80;
            if(GAME.levelColor){
                const eyeHex = GAME.levelColor.eye;
                eyeR = parseInt(eyeHex.substring(1,3), 16);
                eyeG = parseInt(eyeHex.substring(3,5), 16);
                eyeB = parseInt(eyeHex.substring(5,7), 16);
            }
            const glow = ctx.createRadialGradient(monster.x-eyeOffsetX, eyeY, 1, monster.x-eyeOffsetX, eyeY, 18);
            glow.addColorStop(0, 'rgba('+eyeR+','+eyeG+','+eyeB+',0.95)'); 
            glow.addColorStop(1, 'rgba('+eyeR+','+eyeG+','+eyeB+',0)');
            ctx.fillStyle = glow; ctx.beginPath(); ctx.arc(monster.x-eyeOffsetX, eyeY, 10, 0, Math.PI*2); ctx.fill();
            const glow2 = ctx.createRadialGradient(monster.x+eyeOffsetX, eyeY, 1, monster.x+eyeOffsetX, eyeY, 18);
            glow2.addColorStop(0, 'rgba('+eyeR+','+eyeG+','+eyeB+',0.95)'); 
            glow2.addColorStop(1, 'rgba('+eyeR+','+eyeG+','+eyeB+',0)');
            ctx.fillStyle = glow2; ctx.beginPath(); ctx.arc(monster.x+eyeOffsetX, eyeY, 10, 0, Math.PI*2); ctx.fill();
            // eyes pupils
            ctx.fillStyle = '#200000'; ctx.beginPath(); ctx.arc(monster.x-eyeOffsetX, eyeY, 3, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(monster.x+eyeOffsetX, eyeY, 3, 0, Math.PI*2); ctx.fill();
            // mouth teeth
            const mouthW = Math.min(80, mr*1.4);
            const mouthH = 12;
            const mx = monster.x - mouthW/2;
            const my = monster.y + mr*0.45;
            ctx.fillStyle = '#330000'; ctx.fillRect(mx, my, mouthW, mouthH);
            ctx.fillStyle = '#fff';
            for(let t=0;t<6;t++){
                const tx = mx + (t*(mouthW/6)) + 6;
                ctx.beginPath(); ctx.moveTo(tx, my); ctx.lineTo(tx + (mouthW/12), my); ctx.lineTo(tx + (mouthW/24), my - 12); ctx.fill();
            }

            // debug distances (optional)
        }

        function loop(ts){
            if(!lastTime) lastTime = ts;
            const dt = (ts - lastTime)/1000;
            lastTime = ts;
            if(GAME.running){
                update(dt);
                draw();
            }
            requestAnimationFrame(loop);
        }

        // UI hooks
        document.getElementById('startBtn').addEventListener('click', ()=>startLevel(0));
        document.getElementById('levelsBtn').addEventListener('click', ()=>{
            document.getElementById('startOverlay').style.display='none';
            document.getElementById('levelSelect').style.display='flex';
            const container = document.getElementById('levelButtons'); container.innerHTML='';
            const levelColors = ['#2ecc71','#f1c40f','#e67e22','#e74c3c','#8b0000'];
            for(let i=0;i<GAME.levels;i++){
                const b = document.createElement('button'); b.textContent = 'Tase ' + (i+1);
                b.className = 'level-btn';
                const col = levelColors[Math.min(i, levelColors.length-1)];
                b.style.background = col; b.style.color = '#fff';
                b.addEventListener('click', ()=> startLevel(i));
                container.appendChild(b);
            }
        });
        document.getElementById('closeLevelSelect').addEventListener('click', ()=>{document.getElementById('levelSelect').style.display='none';document.getElementById('startOverlay').style.display='flex';});
        document.getElementById('retryBtn').addEventListener('click', ()=> startLevel(GAME.currentLevel));
        document.getElementById('toMenuBtn').addEventListener('click', ()=>{ GAME.running=false; hideAllMenus(); document.getElementById('startOverlay').style.display='flex'; });
        document.getElementById('nextLevelBtn').addEventListener('click', ()=>{ startLevel(GAME.currentLevel+1); document.getElementById('levelCompleteMenu').style.display='none'; });
        document.getElementById('levelSelectBtn').addEventListener('click', ()=>{ document.getElementById('levelCompleteMenu').style.display='none'; document.getElementById('levelSelect').style.display='flex'; });
        document.getElementById('winToMenu').addEventListener('click', ()=>{ hideAllMenus(); document.getElementById('startOverlay').style.display='flex'; });
        // Shop hooks
        document.getElementById('buyBoost').addEventListener('click', ()=>{
            if(GAME.coins >= 10){
                GAME.coins -= 10; document.getElementById('shopCoins').textContent = GAME.coins; document.getElementById('coinHud').textContent = 'Münte: ' + GAME.coins;
                player.speed = player.speedBase * 2.1;
                player.speedBoostUntil = performance.now() + 6000;
                document.getElementById('shopOverlay').style.display='none';
                GAME.running = true;
                levelStartTime += performance.now() - shopPauseTime;
            }
        });
        document.getElementById('buyPermanent').addEventListener('click', ()=>{
            if(GAME.coins >= 25){
                GAME.coins -= 25; document.getElementById('shopCoins').textContent = GAME.coins; document.getElementById('coinHud').textContent = 'Münte: ' + GAME.coins;
                player.speedBase += 40; player.speed = player.speedBase;
                document.getElementById('shopOverlay').style.display='none';
                GAME.running = true;
                levelStartTime += performance.now() - shopPauseTime;
            }
        });
        // buy safety boost (slows monster for a duration)
        document.getElementById('buySafetyBoost').addEventListener('click', ()=>{
            if(GAME.coins >= 100){
                GAME.coins -= 100; document.getElementById('shopCoins').textContent = GAME.coins; document.getElementById('coinHud').textContent = 'Münte: ' + GAME.coins;
                player.safetyBoostUntil = performance.now() + 45000; // 45s
                document.getElementById('shopOverlay').style.display='none';
                GAME.running = true;
                levelStartTime += performance.now() - shopPauseTime;
            }
        });
        // buy coin boost (double coins for a duration)
        document.getElementById('buyCoinBoost').addEventListener('click', ()=>{
            if(GAME.coins >= 12){
                GAME.coins -= 12; document.getElementById('shopCoins').textContent = GAME.coins; document.getElementById('coinHud').textContent = 'Münte: ' + GAME.coins;
                player.coinMultiplier = 2;
                player.coinBoostUntil = performance.now() + 20000; // 20s
                document.getElementById('shopOverlay').style.display='none';
                GAME.running = true;
                levelStartTime += performance.now() - shopPauseTime;
            }
        });
        // Shop tabs
        document.getElementById('shopTabBoosts').addEventListener('click', ()=>{
            document.getElementById('boostSection').style.display = 'flex';
            document.getElementById('cosmSection').style.display = 'none';
        });
        document.getElementById('shopTabCosm').addEventListener('click', ()=>{
            document.getElementById('boostSection').style.display = 'none';
            document.getElementById('cosmSection').style.display = 'flex';
        });

        // Cosmetics purchases
        document.getElementById('buyHat').addEventListener('click', ()=>{
            if(GAME.coins >= 15){
                GAME.coins -= 15; document.getElementById('shopCoins').textContent = GAME.coins; document.getElementById('coinHud').textContent = 'Münte: ' + GAME.coins;
                player.hasHat = true;
                document.getElementById('shopOverlay').style.display='none';
                GAME.running = true;
                levelStartTime += performance.now() - shopPauseTime;
            }
        });
        document.getElementById('buyRedSkin').addEventListener('click', ()=>{
            if(GAME.coins >= 20){
                GAME.coins -= 20; document.getElementById('shopCoins').textContent = GAME.coins; document.getElementById('coinHud').textContent = 'Münte: ' + GAME.coins;
                player.skinColor = '#e03434';
                document.getElementById('shopOverlay').style.display='none';
                GAME.running = true;
                levelStartTime += performance.now() - shopPauseTime;
            }
        });
        document.getElementById('buyBlueSkin').addEventListener('click', ()=>{
            if(GAME.coins >= 20){
                GAME.coins -= 20; document.getElementById('shopCoins').textContent = GAME.coins; document.getElementById('coinHud').textContent = 'Münte: ' + GAME.coins;
                player.skinColor = '#3498db';
                document.getElementById('shopOverlay').style.display='none';
                GAME.running = true;
                levelStartTime += performance.now() - shopPauseTime;
            }
        });
        document.getElementById('buyGoldSkin').addEventListener('click', ()=>{
            if(GAME.coins >= 50){
                GAME.coins -= 50; document.getElementById('shopCoins').textContent = GAME.coins; document.getElementById('coinHud').textContent = 'Münte: ' + GAME.coins;
                player.skinColor = '#f39c12';
                document.getElementById('shopOverlay').style.display='none';
                GAME.running = true;
                levelStartTime += performance.now() - shopPauseTime;
            }
        });

        document.getElementById('closeShop').addEventListener('click', ()=>{ 
            document.getElementById('shopOverlay').style.display='none'; 
            GAME.running = true; // resume game!
            // Adjust timer for pause duration
            levelStartTime += performance.now() - shopPauseTime;
        });

        // Open shop with B (pauses)
        document.addEventListener('keydown', (e)=>{
            if(e.key.toLowerCase() === 'b'){
                if(GAME.running){
                    GAME.running = false; // pause
                    shopPauseTime = performance.now();
                    document.getElementById('shopCoins').textContent = GAME.coins;
                    document.getElementById('shopOverlay').style.display = 'flex';
                } else {
                    if(document.getElementById('shopOverlay').style.display === 'flex'){
                        document.getElementById('shopOverlay').style.display = 'none';
                        GAME.running = true;
                        // adjust timers so we don't lose time while shop open
                        levelStartTime += performance.now() - shopPauseTime;
                    }
                }
            }
            // ESC for pause menu
            if(e.key === 'Escape'){
                if(GAME.running && document.getElementById('pauseMenu').style.display === 'none'){
                    GAME.running = false;
                    shopPauseTime = performance.now();
                    document.getElementById('pauseMenu').style.display = 'flex';
                } else if(document.getElementById('pauseMenu').style.display === 'flex'){
                    document.getElementById('pauseMenu').style.display = 'none';
                    GAME.running = true;
                    levelStartTime += performance.now() - shopPauseTime;
                }
            }
        });

        // Pause menu buttons
        document.getElementById('resumeBtn').addEventListener('click', ()=>{
            document.getElementById('pauseMenu').style.display = 'none';
            GAME.running = true;
            levelStartTime += performance.now() - shopPauseTime;
        });

        document.getElementById('pauseLevelSelectBtn').addEventListener('click', ()=>{
            document.getElementById('pauseMenu').style.display = 'none';
            document.getElementById('levelSelect').style.display = 'flex';
            const container = document.getElementById('levelButtons'); 
            container.innerHTML = '';
            const levelColors = ['#2ecc71','#f1c40f','#e67e22','#e74c3c','#8b0000'];
            for(let i = 0; i < GAME.levels; i++){
                const b = document.createElement('button'); 
                b.textContent = 'Tase ' + (i+1);
                b.className = 'level-btn';
                const col = levelColors[Math.min(i, levelColors.length-1)];
                b.style.background = col; b.style.color = '#fff';
                b.addEventListener('click', ()=> startLevel(i));
                container.appendChild(b);
            }
        });

        document.getElementById('pauseToMenuBtn').addEventListener('click', ()=>{
            GAME.running = false;
            hideAllMenus();
            document.getElementById('startOverlay').style.display = 'flex';
        });

        // Start animation loop (keeps running even when not playing)
        requestAnimationFrame(loop);
    </script>
</body>
</html>
